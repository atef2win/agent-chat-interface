<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Qualification Agent - Chat</title>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body{
      font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height:100vh; display:flex; justify-content:center; align-items:center; padding:20px;
    }
    .container{
      background:white; border-radius:20px; box-shadow:0 20px 60px rgba(0,0,0,0.3);
      max-width:800px; width:100%; overflow:hidden; display:flex; flex-direction:column; max-height:90vh;
    }
    .header{
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color:white; padding:30px; text-align:center;
    }
    .header h1{ font-size:24px; margin-bottom:10px; }
    .header p{ opacity:.9; font-size:14px; }

    .client-id-display{
      background:#f9f9f9; padding:10px 20px; text-align:center; font-size:12px;
      color:#666; border-bottom:1px solid #e0e0e0;
    }

    .chat-box{ padding:30px; overflow-y:auto; flex:1; }

    .message{ margin-bottom:20px; animation: slideIn .3s ease-out; }
    @keyframes slideIn { from{ opacity:0; transform:translateY(10px);} to{opacity:1; transform:translateY(0);} }

    .message.agent{
      background:#f0f0f0; padding:15px; border-radius:15px; border-top-left-radius:0;
    }
    .message.user{
      background:#667eea; color:white; padding:15px; border-radius:15px; border-top-right-radius:0;
      margin-left:auto; max-width:80%;
    }

    .message.agent h1 { font-size:20px; margin:10px 0; color:#667eea; }
    .message.agent h2 { font-size:18px; margin:10px 0; color:#764ba2; }
    .message.agent h3 { font-size:16px; margin:8px 0; color:#333; }
    .message.agent p { margin:8px 0; line-height:1.6; }
    .message.agent ul, .message.agent ol { margin:8px 0; padding-left:20px; }
    .message.agent li { margin:4px 0; }
    .message.agent strong { font-weight:bold; color:#667eea; }
    .message.agent code { background:#e0e0e0; padding:2px 6px; border-radius:4px; font-family:monospace; }
    .message.agent hr { border:none; border-top:2px solid #e0e0e0; margin:15px 0; }

    .loading-message{
      background:#fff3cd; border-left:4px solid #ffc107; padding:15px; border-radius:10px;
      margin-bottom:20px; display:none;
    }
    .loading-message.show{ display:block; }

    .error-message{
      background:#fdecea; border-left:4px solid #f44336; padding:15px; border-radius:10px;
      margin-bottom:20px; display:none;
    }
    .error-message.show{ display:block; }

    .input-area{
      padding:20px 30px 30px; background:#f9f9f9; border-top:1px solid #e0e0e0;
    }
    .input-group{ display:flex; gap:10px; }
    #userMessage{
      flex:1; padding:15px; border:2px solid #e0e0e0; border-radius:25px; font-size:16px;
      transition:border-color .3s;
    }
    #userMessage:focus{ outline:none; border-color:#667eea; }
    #sendBtn{
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color:white; border:none; padding:15px 30px; border-radius:25px; font-size:16px;
      cursor:pointer; transition: transform .2s;
    }
    #sendBtn:hover{ transform: scale(1.05); }
    #sendBtn:active{ transform: scale(.95); }
    #sendBtn:disabled{ opacity:.6; cursor:not-allowed; }

    .loader{
      border:3px solid #f3f3f3; border-top:3px solid #667eea; border-radius:50%;
      width:20px; height:20px; animation: spin 1s linear infinite; display:inline-block; margin-left:10px;
    }
    @keyframes spin { 0% {transform:rotate(0deg);} 100% {transform:rotate(360deg);} }

    .success-message{
      background:#4caf50; color:white; padding:20px; text-align:center; border-radius:10px;
      margin:20px; display:none;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>ü§ñ Agent Qualificator</h1>
      <p>R√©pondez aux questions pour compl√©ter votre qualification</p>
    </div>

    <div class="client-id-display">
      Session ID: <span id="clientIdDisplay"></span>
    </div>

    <div class="chat-box" id="chatBox">
      <div class="loading-message" id="loadingMessage">
        ‚è≥ Pr√©paration de votre qualification en cours.
        <span class="loader"></span>
      </div>
      <div class="error-message" id="errorMessage"></div>
    </div>

    <div class="success-message" id="successMessage">
      ‚úÖ Qualification compl√®te ! Votre demande est en cours de traitement.
    </div>

    <div class="input-area" id="inputArea">
      <div class="input-group">
        <input
          type="text"
          id="userMessage"
          placeholder="Tapez votre r√©ponse ici."
          onkeypress="if(event.key === 'Enter') sendMessage()"
        />
        <button id="sendBtn" onclick="sendMessage()">Envoyer</button>
      </div>
    </div>
  </div>

  <script>
    // Webhooks n8n
    const WEBHOOK_URL = 'https://atefjarray.app.n8n.cloud/webhook/tally-form';
    const GET_QUESTION_URL = 'https://atefjarray.app.n8n.cloud/webhook/get-question';
  
    // State
    let clientId = null;
    let conversationHistory = [];
    let pollingInterval = null;
    let pollingAttempts = 0;
    const MAX_POLLING_ATTEMPTS = 60; // 60 * 1s = 60s
  
    function log(...args){ console.log(...args); }
  
    function showError(msg){
      const el = document.getElementById('errorMessage');
      el.textContent = msg;
      el.classList.add('show');
    }
  
    function clearError(){
      const el = document.getElementById('errorMessage');
      el.textContent = '';
      el.classList.remove('show');
    }
  
    function stopPolling(){
      if (pollingInterval) clearInterval(pollingInterval);
      pollingInterval = null;
      pollingAttempts = 0;
    }
  
    function getParams() {
      const p = new URLSearchParams(window.location.search);
      return {
        client_id: p.get('client_id'),
        mode: p.get('mode'),
        question: p.get('question'),
      };
    }
  
    function resolveClientIdStrict() {
      const { client_id } = getParams();
      if (!client_id || !client_id.trim()) return null;
  
      // Petite validation (optionnelle mais utile)
      // Si tu veux accepter d'autres formats, enl√®ve la ligne startsWith
      if (!client_id.startsWith('client_')) return null;
  
      // Stockage uniquement miroir/debug (NE SERT PAS √† choisir l'id)
      sessionStorage.setItem('client_id_mirror', client_id);
      localStorage.setItem('last_client_id_mirror', client_id);
  
      return client_id;
    }
  
    window.onload = function() {
      stopPolling();
      clearError();
  
      const { mode, question } = getParams();
  
      clientId = resolveClientIdStrict();
  
      log('üöÄ Loaded with', { clientId, mode, href: window.location.href });
  
      document.getElementById('clientIdDisplay').textContent = clientId || '‚Äî';
  
      // Cas mode=initial : on EXIGE client_id dans l'URL
      if (mode === 'initial') {
        if (!clientId) {
          showError("Erreur: client_id manquant ou invalide dans l'URL. Je refuse d'utiliser un ancien ID.");
          document.getElementById('userMessage').disabled = true;
          document.getElementById('sendBtn').disabled = true;
          return;
        }
        startPolling();
        return;
      }
  
      // Si question dans URL ‚Üí afficher direct
      if (question) {
        addMessage('agent', decodeURIComponent(question));
        document.getElementById('userMessage').focus();
        return;
      }
  
      // Sinon message par d√©faut (mais toujours sans fallback d'id)
      addMessage('agent', "Bonjour ! Je suis l'Agent Qualificator. Comment puis-je vous aider aujourd'hui ?");
      document.getElementById('userMessage').focus();
    };
  
    function startPolling() {
      stopPolling();
      clearError();
  
      const loadingMsg = document.getElementById('loadingMessage');
      loadingMsg.classList.add('show');
  
      document.getElementById('userMessage').disabled = true;
      document.getElementById('sendBtn').disabled = true;
  
      pollingInterval = setInterval(checkForQuestion, 1000);
      checkForQuestion();
    }
  
    async function checkForQuestion() {
      pollingAttempts++;
  
      // Re-lire l'URL √† CHAQUE poll (√©vite tout √©tat stale)
      const freshClientId = resolveClientIdStrict();
      if (!freshClientId) {
        stopPolling();
        document.getElementById('loadingMessage').classList.remove('show');
        showError("client_id introuvable/invalide dans l'URL. Impossible d'appeler get-question.");
        return;
      }
      clientId = freshClientId;
  
      const url = `${GET_QUESTION_URL}?client_id=${encodeURIComponent(clientId)}`;
      log(`üîç Poll ${pollingAttempts}/${MAX_POLLING_ATTEMPTS}`, url);
  
      if (pollingAttempts > MAX_POLLING_ATTEMPTS) {
        stopPolling();
        document.getElementById('loadingMessage').classList.remove('show');
        showError("Timeout: la question n'est pas pr√™te. V√©rifie que n8n ins√®re bien la question pour ce client_id.");
        return;
      }
  
      try {
        const response = await fetch(url, { method: 'GET' });
        const data = await response.json();
  
        log('üì• Polling response:', data);
  
        if (data.status === 'ready' && data.question) {
          stopPolling();
          document.getElementById('loadingMessage').classList.remove('show');
  
          // Refuser toute donn√©e pour un autre client_id
          if (data.client_id && data.client_id !== clientId) {
            showError(`Mismatch client_id: front=${clientId} backend=${data.client_id}.`);
            return;
          }
  
          addMessage('agent', data.question);
  
          document.getElementById('userMessage').disabled = false;
          document.getElementById('sendBtn').disabled = false;
          document.getElementById('userMessage').focus();
          return;
        }
  
        if (data.status === 'waiting') return;
  
        log('‚ö†Ô∏è Unexpected status:', data.status);
  
      } catch (e) {
        log('‚ùå Poll error:', e);
        // continue polling
      }
    }
  
    function addMessage(type, text) {
      const chatBox = document.getElementById('chatBox');
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${type}`;
  
      if (type === 'agent') messageDiv.innerHTML = marked.parse(text);
      else messageDiv.textContent = text;
  
      chatBox.appendChild(messageDiv);
      chatBox.scrollTop = chatBox.scrollHeight;
  
      conversationHistory.push({
        role: type === 'agent' ? 'assistant' : 'user',
        content: text
      });
    }
  
    async function sendMessage() {
      clearError();
  
      // Re-lire l'URL juste avant d'envoyer (√©vite √©tat stale)
      const freshClientId = resolveClientIdStrict();
      if (!freshClientId) {
        showError("client_id manquant/invalide dans l'URL. Je n'envoie rien.");
        return;
      }
      clientId = freshClientId;
  
      const input = document.getElementById('userMessage');
      const message = input.value.trim();
      if (!message) return;
  
      addMessage('user', message);
      input.value = '';
  
      input.disabled = true;
      document.getElementById('sendBtn').disabled = true;
  
      try {
        const payload = {
          client_id: clientId,
          message: message,
          conversation_history: conversationHistory
        };
  
        const response = await fetch(WEBHOOK_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
  
        const data = await response.json();
        log('üì• Send response:', data);
  
        if (data.status === 'COMPLETE' || data.status === 'complete') {
          document.getElementById('successMessage').style.display = 'block';
          document.getElementById('inputArea').style.display = 'none';
          addMessage('agent', '‚úÖ Merci ! Votre qualification est compl√®te.');
          return;
        }
  
        if (data.status === 'incomplete' || data.status === 'INCOMPLETE') {
          addMessage('agent', data.question || data.agent_question || 'Pouvez-vous pr√©ciser ?');
          input.disabled = false;
          document.getElementById('sendBtn').disabled = false;
          input.focus();
          return;
        }
  
        if (data.status === 'processing') {
          // IMPORTANT: En mode initial, on ne redirige jamais automatiquement.
          const { mode } = getParams();
          if (mode !== 'initial' && data.redirect_url) {
            // S√©curit√©: rediriger seulement si l'URL contient le m√™me client_id
            try {
              const u = new URL(data.redirect_url);
              const rid = u.searchParams.get('client_id');
              if (rid === clientId) {
                window.location.href = data.redirect_url;
                return;
              } else {
                showError(`Redirect refus√©e: client_id diff√©rent (front=${clientId} redirect=${rid}).`);
              }
            } catch(_) {
              showError("Redirect_url invalide re√ßue du backend.");
            }
          }
  
          addMessage('agent', 'Traitement en cours...');
          input.disabled = false;
          document.getElementById('sendBtn').disabled = false;
          input.focus();
          return;
        }
  
        addMessage('agent', data.question || data.message || 'Une erreur est survenue. Pouvez-vous reformuler ?');
        input.disabled = false;
        document.getElementById('sendBtn').disabled = false;
  
      } catch (e) {
        showError("Erreur r√©seau lors de l'envoi. R√©essaie.");
        input.disabled = false;
        document.getElementById('sendBtn').disabled = false;
      }
    }
  </script>  
</body>
</html>

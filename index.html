<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Qualification Agent - Chat Enhanced</title>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    
    body{
      font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      min-height:100vh; 
      display:flex; 
      justify-content:center; 
      align-items:center; 
      padding:20px;
      
      /* Background image from Imgur */
      background-image: url('https://res.cloudinary.com/ddjovu7kn/image/upload/v1768229348/gemini-2.5-flash-image_best_quality_ever_on_this_image_with_a_purple_violet_background_keeping_the_orig-0_a33pb8.jpg');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      background-repeat: no-repeat;
      position: relative;
    }
    
    /* Dark overlay for better readability */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.4);
      z-index: 0;
    }
    
    .container{
      background: white;
      border-radius:20px; 
      box-shadow:0 20px 60px rgba(0,0,0,0.3);
      max-width:800px; 
      width:100%; 
      overflow:hidden; 
      display:flex; 
      flex-direction:column; 
      max-height:90vh;
      position: relative;
      z-index: 1;
    }
    
    .header{
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color:white; 
      padding:30px; 
      text-align:center;
    }
    .header h1{ 
      font-size:28px; 
      margin-bottom:10px; 
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    .header p{ opacity:.9; font-size:14px; }

    .client-id-display{
      background:#f9f9f9; 
      padding:10px 20px; 
      text-align:center; 
      font-size:12px;
      color:#666; 
      border-bottom:1px solid #e0e0e0;
    }

    .chat-box{ 
      padding:30px; 
      overflow-y:auto; 
      flex:1; 
      background: #fafafa;
    }

    .message{ 
      margin-bottom:20px; 
      animation: slideIn .3s ease-out; 
    }
    @keyframes slideIn { 
      from{ opacity:0; transform:translateY(10px);} 
      to{opacity:1; transform:translateY(0);} 
    }

    .message.agent{
      background:#f0f0f0; 
      padding:15px; 
      border-radius:15px; 
      border-top-left-radius:0;
      max-width: 90%;
    }
    .message.user{
      background:#667eea; 
      color:white; 
      padding:15px; 
      border-radius:15px; 
      border-top-right-radius:0;
      margin-left:auto; 
      max-width:80%;
    }
    
    .message.system{
      background:#fff3cd; 
      border-left:4px solid #ffc107; 
      padding:15px; 
      border-radius:10px;
      text-align: center;
      font-style: italic;
      color: #856404;
    }

    .message.agent h1 { font-size:20px; margin:10px 0; color:#667eea; }
    .message.agent h2 { font-size:18px; margin:10px 0; color:#764ba2; }
    .message.agent h3 { font-size:16px; margin:8px 0; color:#333; }
    .message.agent p { margin:8px 0; line-height:1.6; }
    .message.agent ul, .message.agent ol { margin:8px 0; padding-left:20px; }
    .message.agent li { margin:4px 0; }
    .message.agent strong { font-weight:bold; color:#667eea; }
    .message.agent code { background:#e0e0e0; padding:2px 6px; border-radius:4px; font-family:monospace; }
    .message.agent hr { border:none; border-top:2px solid #e0e0e0; margin:15px 0; }

    /* Interactive response options */
    .response-options {
      margin-top: 15px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .response-button {
      background: white;
      border: 2px solid #667eea;
      color: #667eea;
      padding: 12px 20px;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s;
      text-align: left;
      font-size: 15px;
      font-weight: 500;
    }
    
    .response-button:hover {
      background: #667eea;
      color: white;
      transform: translateX(5px);
    }
    
    .response-button:active {
      transform: translateX(5px) scale(0.98);
    }
    
    .checkbox-option, .radio-option {
      display: flex;
      align-items: center;
      padding: 12px;
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .checkbox-option:hover, .radio-option:hover {
      border-color: #667eea;
      background: #f8f9ff;
    }
    
    .checkbox-option input, .radio-option input {
      margin-right: 10px;
      width: 20px;
      height: 20px;
      cursor: pointer;
      accent-color: #667eea;
    }
    
    .checkbox-option label, .radio-option label {
      cursor: pointer;
      flex: 1;
      user-select: none;
    }
    
    .checkbox-option.checked, .radio-option.checked {
      border-color: #667eea;
      background: #f0f4ff;
    }
    
    .submit-selected {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      margin-top: 10px;
      transition: transform 0.2s;
    }
    
    .submit-selected:hover {
      transform: scale(1.05);
    }
    
    .submit-selected:active {
      transform: scale(0.98);
    }
    
    .submit-selected:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .loading-message{
      background:#fff3cd; 
      border-left:4px solid #ffc107; 
      padding:15px; 
      border-radius:10px;
      margin-bottom:20px; 
      display:none;
    }
    .loading-message.show{ display:block; }

    .error-message{
      background:#fdecea; 
      border-left:4px solid #f44336; 
      padding:15px; 
      border-radius:10px;
      margin-bottom:20px; 
      display:none;
    }
    .error-message.show{ display:block; }

    .input-area{
      padding:20px 30px 30px; 
      background:white; 
      border-top:1px solid #e0e0e0;
    }
    .input-group{ 
      display:flex; 
      gap:10px; 
      align-items: center; 
    }
    
    #userMessage{
      flex:1; 
      padding:15px 20px; 
      border:2px solid #e0e0e0; 
      border-radius:25px; 
      font-size:16px;
      transition:border-color .3s; 
      background: white;
    }
    #userMessage:focus{ 
      outline:none; 
      border-color:#667eea; 
    }
    
    #voiceBtn {
      background: white;
      border: 2px solid #667eea;
      color: #667eea;
      padding: 0;
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.3s;
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      flex-shrink: 0;
    }
    
    #voiceBtn:hover {
      background: #667eea;
      color: white;
      transform: scale(1.05);
    }
    
    #voiceBtn.recording {
      background: #f44336;
      border-color: #f44336;
      color: white;
      animation: pulse 1s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.1); opacity: 0.8; }
    }
    
    #sendBtn{
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color:white; 
      border:none; 
      padding:15px 30px; 
      border-radius:25px; 
      font-size:16px;
      font-weight: 600;
      cursor:pointer; 
      transition: transform .2s;
      flex-shrink: 0;
    }
    #sendBtn:hover{ transform: scale(1.05); }
    #sendBtn:active{ transform: scale(.95); }
    #sendBtn:disabled{ opacity:.6; cursor:not-allowed; }

    .loader{
      border:3px solid #f3f3f3; 
      border-top:3px solid #667eea; 
      border-radius:50%;
      width:20px; 
      height:20px; 
      animation: spin 1s linear infinite; 
      display:inline-block; 
      margin-left:10px;
    }
    @keyframes spin { 
      0% {transform:rotate(0deg);} 
      100% {transform:rotate(360deg);} 
    }

    .success-message{
      background:#4caf50; 
      color:white; 
      padding:20px; 
      text-align:center; 
      border-radius:10px;
      margin:20px; 
      display:none;
      font-size: 18px;
      font-weight: 600;
    }
    
    .voice-indicator {
      display: none;
      background: #f44336;
      color: white;
      padding: 10px 20px;
      border-radius: 20px;
      margin-bottom: 10px;
      text-align: center;
      animation: pulse 1s infinite;
      font-weight: 600;
    }
    
    .voice-indicator.show {
      display: block;
    }

    /* Responsive */
    @media (max-width: 600px) {
      .container { max-width: 100%; margin: 10px; }
      .header h1 { font-size: 22px; }
      .input-group { flex-wrap: wrap; }
      #userMessage { min-width: 100%; }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1><span>ü§ñ</span> Agent Qualificator</h1>
      <p>R√©pondez aux questions pour compl√©ter votre qualification</p>
    </div>

    <div class="client-id-display">
      Session ID: <span id="clientIdDisplay"></span>
    </div>

    <div class="chat-box" id="chatBox">
      <div class="loading-message" id="loadingMessage">
        ‚è≥ Pr√©paration de votre qualification en cours.
        <span class="loader"></span>
      </div>
      <div class="error-message" id="errorMessage"></div>
    </div>

    <div class="success-message" id="successMessage">
      ‚úÖ Qualification compl√®te ! Votre demande est en cours de traitement.
    </div>

    <div class="input-area" id="inputArea">
      <div class="voice-indicator" id="voiceIndicator">
        üé§ Enregistrement en cours...
      </div>
      <div class="input-group">
        <button id="voiceBtn" onclick="toggleVoiceInput()" title="Commande vocale">
          üé§
        </button>
        <input
          type="text"
          id="userMessage"
          placeholder="Tapez votre r√©ponse ou utilisez la commande vocale..."
          onkeypress="if(event.key === 'Enter') sendMessage()"
        />
        <button id="sendBtn" onclick="sendMessage()">Envoyer</button>
      </div>
    </div>
  </div>

  <script>
    // Webhooks n8n
    const WEBHOOK_URL = 'https://atefjarray.app.n8n.cloud/webhook/tally-form';
    const GET_QUESTION_URL = 'https://atefjarray.app.n8n.cloud/webhook/get-question';
  
    // State
    let clientId = null;
    let conversationHistory = [];
    let pollingInterval = null;
    let pollingAttempts = 0;
    const MAX_POLLING_ATTEMPTS = 60;
    
    // Voice recognition
    let recognition = null;
    let isRecording = false;
    
    // Initialize speech recognition
    function initVoiceRecognition() {
      console.log('üé§ Initializing voice recognition...');
      
      if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.lang = 'fr-FR';
        recognition.continuous = false;
        recognition.interimResults = false;
        
        recognition.onstart = function() {
          console.log('üé§ Voice recognition started');
        };
        
        recognition.onresult = function(event) {
          const transcript = event.results[0][0].transcript;
          console.log('üé§ Transcript:', transcript);
          document.getElementById('userMessage').value = transcript;
          stopVoiceRecording();
        };
        
        recognition.onerror = function(event) {
          console.error('üé§ Speech recognition error:', event.error);
          stopVoiceRecording();
          if (event.error !== 'no-speech') {
            showError('Erreur de reconnaissance vocale. Veuillez r√©essayer.');
          }
        };
        
        recognition.onend = function() {
          console.log('üé§ Voice recognition ended');
          stopVoiceRecording();
        };
        
        console.log('‚úÖ Voice recognition initialized successfully');
      } else {
        console.warn('‚ùå Speech recognition not supported in this browser');
        document.getElementById('voiceBtn').style.display = 'none';
      }
    }
    
    function toggleVoiceInput() {
      console.log('üé§ Toggle voice input, currently recording:', isRecording);
      
      if (isRecording) {
        stopVoiceRecording();
      } else {
        startVoiceRecording();
      }
    }
    
    function startVoiceRecording() {
      if (!recognition) {
        showError('La reconnaissance vocale n\'est pas support√©e par votre navigateur.');
        return;
      }
      
      console.log('üé§ Starting voice recording...');
      isRecording = true;
      document.getElementById('voiceBtn').classList.add('recording');
      document.getElementById('voiceIndicator').classList.add('show');
      document.getElementById('userMessage').value = '';
      
      try {
        recognition.start();
      } catch (e) {
        console.error('üé§ Error starting recognition:', e);
        stopVoiceRecording();
      }
    }
    
    function stopVoiceRecording() {
      console.log('üé§ Stopping voice recording...');
      isRecording = false;
      document.getElementById('voiceBtn').classList.remove('recording');
      document.getElementById('voiceIndicator').classList.remove('show');
      
      if (recognition) {
        try {
          recognition.stop();
        } catch (e) {
          console.log('üé§ Recognition already stopped');
        }
      }
    }
  
    function log(...args){ console.log(...args); }
  
    function showError(msg){
      const el = document.getElementById('errorMessage');
      el.textContent = msg;
      el.classList.add('show');
      setTimeout(() => el.classList.remove('show'), 5000);
    }
  
    function clearError(){
      const el = document.getElementById('errorMessage');
      el.textContent = '';
      el.classList.remove('show');
    }
  
    function stopPolling(){
      if (pollingInterval) clearInterval(pollingInterval);
      pollingInterval = null;
      pollingAttempts = 0;
    }
  
    function getParams() {
      const p = new URLSearchParams(window.location.search);
      return {
        client_id: p.get('client_id'),
        mode: p.get('mode'),
        question: p.get('question'),
      };
    }
  
    function resolveClientIdStrict() {
      const { client_id } = getParams();
      if (!client_id || !client_id.trim()) return null;
      if (!client_id.startsWith('client_')) return null;
      
      sessionStorage.setItem('client_id_mirror', client_id);
      localStorage.setItem('last_client_id_mirror', client_id);
      
      return client_id;
    }
  
    window.onload = function() {
      console.log('üöÄ Application loading...');
      initVoiceRecognition();
      stopPolling();
      clearError();
  
      const { mode, question } = getParams();
      clientId = resolveClientIdStrict();
  
      log('üöÄ Loaded with', { clientId, mode, href: window.location.href });
      document.getElementById('clientIdDisplay').textContent = clientId || '‚Äî';
  
      if (mode === 'initial') {
        if (!clientId) {
          showError("Erreur: client_id manquant ou invalide dans l'URL.");
          document.getElementById('userMessage').disabled = true;
          document.getElementById('sendBtn').disabled = true;
          document.getElementById('voiceBtn').disabled = true;
          return;
        }
        startPolling();
        return;
      }
  
      if (question) {
        addMessage('agent', decodeURIComponent(question));
        document.getElementById('userMessage').focus();
        return;
      }
  
      addMessage('agent', "Bonjour ! Je suis l'Agent Qualificator. Comment puis-je vous aider aujourd'hui ?");
      document.getElementById('userMessage').focus();
    };
  
    function startPolling() {
      stopPolling();
      clearError();
  
      const loadingMsg = document.getElementById('loadingMessage');
      loadingMsg.classList.add('show');
  
      document.getElementById('userMessage').disabled = true;
      document.getElementById('sendBtn').disabled = true;
      document.getElementById('voiceBtn').disabled = true;
  
      pollingInterval = setInterval(checkForQuestion, 1000);
      checkForQuestion();
    }
  
    async function checkForQuestion() {
      pollingAttempts++;
      const freshClientId = resolveClientIdStrict();
      
      if (!freshClientId) {
        stopPolling();
        document.getElementById('loadingMessage').classList.remove('show');
        showError("client_id introuvable dans l'URL.");
        return;
      }
      
      clientId = freshClientId;
      const url = `${GET_QUESTION_URL}?client_id=${encodeURIComponent(clientId)}`;
      log(`üîç Poll ${pollingAttempts}/${MAX_POLLING_ATTEMPTS}`, url);
  
      if (pollingAttempts > MAX_POLLING_ATTEMPTS) {
        stopPolling();
        document.getElementById('loadingMessage').classList.remove('show');
        showError("Timeout: la question n'est pas pr√™te.");
        return;
      }
  
      try {
        const response = await fetch(url, { method: 'GET' });
        const data = await response.json();
        log('üì• Polling response:', data);
  
        if (data.status === 'ready' && data.question) {
          stopPolling();
          document.getElementById('loadingMessage').classList.remove('show');
  
          if (data.client_id && data.client_id !== clientId) {
            showError(`Mismatch client_id.`);
            return;
          }
  
          addMessage('agent', data.question);
  
          document.getElementById('userMessage').disabled = false;
          document.getElementById('sendBtn').disabled = false;
          document.getElementById('voiceBtn').disabled = false;
          document.getElementById('userMessage').focus();
          return;
        }
      } catch (e) {
        log('‚ùå Poll error:', e);
      }
    }
  
    function parseInteractiveOptions(text) {
      console.log('üîç Parsing text for interactive options:', text.substring(0, 100) + '...');
      
      const lines = text.split('\n');
      const options = [];
      let questionText = '';
      let inOptions = false;
      
      for (let line of lines) {
        const trimmed = line.trim();
        
        // Detect option patterns: -, *, ‚Ä¢, 1., 2., [ ]
        const optionMatch = trimmed.match(/^([-*‚Ä¢]|\d+[.)]|\[\s*\])\s+(.+)$/);
        
        if (optionMatch) {
          inOptions = true;
          const optionText = optionMatch[2].trim();
          
          if (optionText && optionText.length > 0) {
            options.push(optionText);
            console.log('  ‚úÖ Found option:', optionText);
          }
        } else if (trimmed.length > 0) {
          if (!inOptions) {
            questionText += (questionText ? '\n' : '') + trimmed;
          }
        }
      }
      
      console.log(`üîç Parsing result: ${options.length} options found`);
      return { questionText: questionText || text, options };
    }
  
    function addMessage(type, text) {
      const chatBox = document.getElementById('chatBox');
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${type}`;
  
      if (type === 'agent') {
        const { questionText, options } = parseInteractiveOptions(text);
        
        // Render markdown
        messageDiv.innerHTML = marked.parse(questionText);
        
        // Add interactive options if detected
        if (options.length > 0 && options.length <= 10) {
          console.log('‚úÖ Creating interactive UI for', options.length, 'options');
          
          const optionsContainer = document.createElement('div');
          optionsContainer.className = 'response-options';
          
          // Determine if single or multiple choice
          const isMultiple = questionText.toLowerCase().includes('s√©lectionn') || 
                           questionText.toLowerCase().includes('plusieurs') ||
                           questionText.toLowerCase().includes('cochez') ||
                           questionText.toLowerCase().includes('tous');
          
          console.log('  Multiple choice detected:', isMultiple);
          
          if (isMultiple) {
            // Checkboxes for multiple choice
            options.forEach((option, index) => {
              const optionDiv = document.createElement('div');
              optionDiv.className = 'checkbox-option';
              optionDiv.innerHTML = `
                <input type="checkbox" id="option_${index}" value="${option.replace(/"/g, '&quot;')}">
                <label for="option_${index}">${option}</label>
              `;
              
              optionDiv.onclick = function(e) {
                if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'LABEL') {
                  const checkbox = optionDiv.querySelector('input');
                  checkbox.checked = !checkbox.checked;
                  optionDiv.classList.toggle('checked', checkbox.checked);
                }
              };
              
              optionDiv.querySelector('input').onchange = function() {
                optionDiv.classList.toggle('checked', this.checked);
              };
              
              optionsContainer.appendChild(optionDiv);
            });
            
            // Submit button
            const submitBtn = document.createElement('button');
            submitBtn.className = 'submit-selected';
            submitBtn.textContent = 'Valider ma s√©lection';
            submitBtn.onclick = function() {
              const selected = [];
              document.querySelectorAll('.checkbox-option input:checked').forEach(cb => {
                selected.push(cb.value);
              });
              
              if (selected.length > 0) {
                document.getElementById('userMessage').value = selected.join(', ');
                sendMessage();
              } else {
                showError('Veuillez s√©lectionner au moins une option');
              }
            };
            optionsContainer.appendChild(submitBtn);
            
          } else {
            // Single choice buttons
            options.forEach(option => {
              const button = document.createElement('button');
              button.className = 'response-button';
              button.textContent = option;
              button.onclick = function() {
                document.getElementById('userMessage').value = option;
                sendMessage();
              };
              optionsContainer.appendChild(button);
            });
          }
          
          messageDiv.appendChild(optionsContainer);
        }
      } else if (type === 'system') {
        messageDiv.textContent = text;
      } else {
        messageDiv.textContent = text;
      }
  
      chatBox.appendChild(messageDiv);
      chatBox.scrollTop = chatBox.scrollHeight;
  
      if (type !== 'system') {
        conversationHistory.push({
          role: type === 'agent' ? 'assistant' : 'user',
          content: type === 'agent' ? text : text
        });
      }
    }
  
    async function sendMessage() {
      clearError();
      
      const freshClientId = resolveClientIdStrict();
      if (!freshClientId) {
        showError("client_id manquant dans l'URL.");
        return;
      }
      clientId = freshClientId;
  
      const input = document.getElementById('userMessage');
      const message = input.value.trim();
      if (!message) return;
  
      addMessage('user', message);
      input.value = '';
  
      input.disabled = true;
      document.getElementById('sendBtn').disabled = true;
      document.getElementById('voiceBtn').disabled = true;
      
      // Show loading indicator
      addMessage('system', '‚è≥ Analyse en cours...');
  
      try {
        const payload = {
          client_id: clientId,
          message: message,
          conversation_history: conversationHistory
        };
  
        const response = await fetch(WEBHOOK_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
  
        const data = await response.json();
        log('üì• Send response:', data);
        
        // Remove loading indicator
        const systemMessages = document.querySelectorAll('.message.system');
        systemMessages.forEach(msg => msg.remove());
  
        if (data.status === 'COMPLETE' || data.status === 'complete') {
          document.getElementById('successMessage').style.display = 'block';
          document.getElementById('inputArea').style.display = 'none';
          addMessage('agent', '‚úÖ Merci ! Votre qualification est compl√®te.');
          return;
        }
  
        if (data.status === 'incomplete' || data.status === 'INCOMPLETE') {
          addMessage('agent', data.question || data.agent_question || 'Pouvez-vous pr√©ciser ?');
          input.disabled = false;
          document.getElementById('sendBtn').disabled = false;
          document.getElementById('voiceBtn').disabled = false;
          input.focus();
          return;
        }
  
        if (data.status === 'processing') {
          const { mode } = getParams();
          if (mode !== 'initial' && data.redirect_url) {
            try {
              const u = new URL(data.redirect_url);
              const rid = u.searchParams.get('client_id');
              if (rid === clientId) {
                window.location.href = data.redirect_url;
                return;
              } else {
                showError(`Redirect refus√©e: client_id diff√©rent.`);
              }
            } catch(_) {
              showError("Redirect_url invalide.");
            }
          }
  
          addMessage('agent', 'Traitement en cours...');
          input.disabled = false;
          document.getElementById('sendBtn').disabled = false;
          document.getElementById('voiceBtn').disabled = false;
          input.focus();
          return;
        }
  
        addMessage('agent', data.question || data.message || 'Une erreur est survenue.');
        input.disabled = false;
        document.getElementById('sendBtn').disabled = false;
        document.getElementById('voiceBtn').disabled = false;
  
      } catch (e) {
        console.error('‚ùå Send error:', e);
        showError("Erreur r√©seau. R√©essayez.");
        input.disabled = false;
        document.getElementById('sendBtn').disabled = false;
        document.getElementById('voiceBtn').disabled = false;
        
        // Remove loading indicator on error
        const systemMessages = document.querySelectorAll('.message.system');
        systemMessages.forEach(msg => msg.remove());
      }
    }
  </script>  
</body>
</html>
